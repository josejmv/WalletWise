# WalletWise v1.4.0 - Mejoras y Nuevas Funcionalidades

> Nuevas funcionalidades, responsive design y mejoras de UX

**Version:** 1.4.0
**Estado:** Completado
**Fecha:** Enero 2026

---

## Resumen Ejecutivo

Version 1.4.0 agrega nuevas funcionalidades importantes y mejoras de UX.

**Total: 9 cambios principales organizados en 9 fases - TODAS COMPLETADAS**

---

## Decisiones de Diseno (Confirmadas con Usuario)

### 1. Ingresos Extra (Sin Trabajo)

- **Mismo formulario**: Hacer jobId opcional en el formulario actual
- **Descripcion**: Campo opcional para explicar origen del ingreso
- **Sin defaults**: Usuario selecciona moneda y cuenta manualmente
- **UI**: Mostrar "Ingreso Extra" cuando no hay trabajo asociado

### 2. DatePicker

- **Flechas arriba**: Mover navegacion a barra superior separada
- **Dias mas pequenos**: Reducir ligeramente el tamano de los dias

### 3. Presupuestos sin Objetivo

- **Mostrar monto**: Solo mostrar monto actual sin barra ni porcentaje
- **Fix validacion**: Usar transform() para manejar NaN en targetAmount

### 4. Estado de Carga

- **Barra superior**: Estilo NProgress en la parte superior
- **Color**: Primary (azul) del tema

### 5. Consumo de Inventario

- **Modal con lista**: Seleccionar multiples productos y cantidades
- **Solo cantidad**: No crear gasto, solo reducir inventario
- **Ubicacion**: Dashboard + Inventario + Quick Actions
- **Sin historial**: Por ahora no registrar historial de consumos
- **Stock cero**: Producto queda visible, sistema detecta para shopping list

### 6. Precio Est Spacing

- **Formato**: Agregar espacio entre simbolo y monto (VES 0 en lugar de VES0)

### 7. Responsive

- **Todos los dispositivos**: Revision exhaustiva de todas las paginas
- **Prioridad**: Tablas, formularios, sidebar, graficos

### 8. Query Invalidation

- **Fix**: Invalidar inventory-categories al crear/editar items

### 9. Rutas de Conversion Alternativas (COP-VES)

- **Ruta actual**: COP -> USD -> VES (via tasa oficial)
- **Nueva ruta**: COP -> USDT -> VES (via Binance P2P)
- **Comparacion**: Mostrar ambas tasas para que el usuario compare
- **Uso**: Permitir elegir que ruta usar en conversiones

---

## Fases de Implementacion

### Fase 1: Ingresos Extra (Sin Trabajo Asociado)

**Objetivo:** Permitir registrar ingresos sin asociar a un trabajo

| #   | Tarea                                                     | Archivos                                            |
| --- | --------------------------------------------------------- | --------------------------------------------------- |
| 1.1 | Hacer jobId opcional en Prisma schema                     | `prisma/schema.prisma`                              |
| 1.2 | Actualizar schema de validacion para jobId opcional       | `app/api/incomes/schema.ts`                         |
| 1.3 | Actualizar tipos TypeScript                               | `app/api/incomes/types.ts`                          |
| 1.4 | Modificar service para validar job solo si se proporciona | `app/api/incomes/service.ts`                        |
| 1.5 | Actualizar repository para manejar job opcional           | `app/api/incomes/repository.ts`                     |
| 1.6 | Modificar formulario para hacer trabajo opcional          | `app/dashboard/incomes/_components/income-form.tsx` |
| 1.7 | Actualizar pagina para mostrar "Ingreso Extra" si no hay  | `app/dashboard/incomes/page.tsx`                    |
| 1.8 | Actualizar historial de transacciones para manejar null   | `app/dashboard/transactions/history/page.tsx`       |

**Cambios en Prisma:**

```prisma
model Income {
  jobId String?  // Opcional
  job   Job?     @relation(fields: [jobId], references: [id])
}
```

**Cambios en Form:**

- Agregar opcion "Sin trabajo (Ingreso Extra)" al select
- Mostrar campos de moneda/cuenta siempre (sin defaults)
- Descripcion visible y recomendada cuando no hay trabajo

---

### Fase 2: Fix DatePicker (Flechas y Tamano)

**Objetivo:** Mejorar usabilidad del calendario moviendo flechas arriba

| #   | Tarea                                                 | Archivos                        |
| --- | ----------------------------------------------------- | ------------------------------- |
| 2.1 | Reorganizar layout del calendario con header separado | `components/ui/calendar.tsx`    |
| 2.2 | Mover flechas de navegacion a barra superior          | `components/ui/calendar.tsx`    |
| 2.3 | Reducir tamano de celdas de dias                      | `components/ui/calendar.tsx`    |
| 2.4 | Ajustar ancho del popover si es necesario             | `components/ui/date-picker.tsx` |

**Estructura propuesta:**

```
┌────────────────────────────┐
│  <   Enero 2026    >       │  <- Flechas en header separado
├────────────────────────────┤
│ Lu Ma Mi Ju Vi Sa Do       │
│  1  2  3  4  5  6  7       │
│  8  9 10 11 12 13 14       │
│ ...                        │
└────────────────────────────┘
```

---

### Fase 3: Fix Budget targetAmount Validation

**Objetivo:** Corregir error de validacion cuando targetAmount esta vacio

| #   | Tarea                                              | Archivos                                            |
| --- | -------------------------------------------------- | --------------------------------------------------- |
| 3.1 | Usar transform() para manejar NaN antes de valid   | `app/api/budgets/schema.ts`                         |
| 3.2 | Actualizar form schema para manejar valores vacios | `app/dashboard/budgets/_components/budget-form.tsx` |
| 3.3 | Mostrar solo monto actual cuando no hay objetivo   | `app/dashboard/budgets/page.tsx`                    |
| 3.4 | Actualizar detalle de budget para manejar sin obj  | `app/dashboard/budgets/[id]/page.tsx`               |

**Fix en schema.ts:**

```typescript
targetAmount: z.number()
  .transform((v) => (Number.isNaN(v) ? null : v))
  .nullable()
  .optional()
  .refine((v) => v === null || v === undefined || v > 0, {
    message: "El monto objetivo debe ser mayor a 0",
  });
```

---

### Fase 4: Estado de Carga entre Paginas (NProgress)

**Objetivo:** Mostrar barra de progreso al navegar entre paginas

| #   | Tarea                                         | Archivos                                  |
| --- | --------------------------------------------- | ----------------------------------------- |
| 4.1 | Instalar dependencia de barra de progreso     | `package.json`                            |
| 4.2 | Crear componente de barra de progreso         | `components/ui/progress-bar.tsx`          |
| 4.3 | Integrar con eventos de navegacion de Next.js | `components/layout/progress-provider.tsx` |
| 4.4 | Agregar provider al layout principal          | `app/layout.tsx`                          |
| 4.5 | Configurar color primary y estilos            | `components/ui/progress-bar.tsx`          |

**Opciones de implementacion:**

- `nprogress` + `@types/nprogress` (clasico, ligero)
- `next-nprogress-bar` (wrapper para Next.js App Router)

**Integracion:**

```tsx
// components/layout/progress-provider.tsx
"use client";
import { AppProgressBar } from "next-nprogress-bar";

export function ProgressProvider({ children }) {
  return (
    <>
      {children}
      <AppProgressBar
        height="3px"
        color="hsl(var(--primary))"
        options={{ showSpinner: false }}
      />
    </>
  );
}
```

---

### Fase 5: Query Invalidation para Inventory Categories

**Objetivo:** Actualizar categorias cuando se crea/edita un item

| #   | Tarea                                                     | Archivos                                                      |
| --- | --------------------------------------------------------- | ------------------------------------------------------------- |
| 5.1 | Agregar invalidacion de inventory-categories en item form | `app/dashboard/inventory/_components/inventory-item-form.tsx` |
| 5.2 | Agregar invalidacion en pagina principal de inventario    | `app/dashboard/inventory/page.tsx`                            |

**Cambio simple:**

```typescript
// En inventory-item-form.tsx o inventory/page.tsx (handleFormSuccess)
queryClient.invalidateQueries({ queryKey: ["inventory-categories"] });
```

---

### Fase 6: Fix Precio Estimado Spacing

**Objetivo:** Agregar espacio entre simbolo de moneda y monto

| #   | Tarea                                                    | Archivos                           |
| --- | -------------------------------------------------------- | ---------------------------------- |
| 6.1 | Modificar formatCurrency para agregar espacio            | `lib/formatters.ts`                |
| 6.2 | Verificar que UserConfigContext formatCurrency tenga esp | `contexts/user-config-context.tsx` |
| 6.3 | Verificar todas las paginas que usan formatCurrency      | Multiple                           |

**Cambio en formatters.ts:**

```typescript
// Antes: return `${CURRENCY_SYMBOLS[currency] || currency}${formatted}`;
// Despues:
return `${CURRENCY_SYMBOLS[currency] || currency} ${formatted}`;
```

---

### Fase 7: Modal de Consumo de Inventario

**Objetivo:** Registrar consumo de productos reduciendo cantidad en inventario

| #   | Tarea                                         | Archivos                                      |
| --- | --------------------------------------------- | --------------------------------------------- |
| 7.1 | Crear endpoint PATCH para consumo masivo      | `app/api/inventory-items/consume/route.ts`    |
| 7.2 | Crear modal de consumo con lista de productos | `components/inventory/consume-modal.tsx`      |
| 7.3 | Agregar boton en pagina de inventario         | `app/dashboard/inventory/page.tsx`            |
| 7.4 | Agregar boton en dashboard (Quick Actions)    | `app/dashboard/_components/quick-actions.tsx` |
| 7.5 | Agregar accion rapida en sidebar/header       | `components/layout/`                          |
| 7.6 | Invalidar queries de inventario y shopping    | `components/inventory/consume-modal.tsx`      |

**Estructura del Modal:**

```
┌─────────────────────────────────────────────┐
│        Registrar Consumo                    │
├─────────────────────────────────────────────┤
│ Buscar producto...                    [O]   │
├─────────────────────────────────────────────┤
│ [ ] Arroz          Stock: 5kg    [-] 1 [+]  │
│ [ ] Leche          Stock: 3L     [-] 0 [+]  │
│ [ ] Azucar         Stock: 2kg    [-] 0 [+]  │
│ ...                                         │
├─────────────────────────────────────────────┤
│ Productos seleccionados: 1                  │
│                                             │
│        [Cancelar]  [Registrar Consumo]      │
└─────────────────────────────────────────────┘
```

**API Endpoint:**

```typescript
// POST /api/inventory-items/consume
{
  items: [
    { id: "uuid", quantity: 2 },
    { id: "uuid", quantity: 1 },
  ];
}
// Response: updated items array
```

---

### Fase 8: Revision Responsive Completa

**Objetivo:** Asegurar que toda la app funcione bien en movil/tablet

| #   | Tarea                                    | Archivos                          |
| --- | ---------------------------------------- | --------------------------------- |
| 8.1 | Auditar y fix sidebar en movil           | `components/layout/sidebar.tsx`   |
| 8.2 | Auditar y fix tablas (scroll horizontal) | Multiple paginas                  |
| 8.3 | Auditar y fix formularios                | Multiple forms                    |
| 8.4 | Auditar y fix modales                    | Multiple modales                  |
| 8.5 | Auditar y fix graficos en dashboard      | `app/dashboard/_components/`      |
| 8.6 | Auditar y fix pagina de settings         | `app/dashboard/settings/page.tsx` |
| 8.7 | Auditar y fix DatePicker en movil        | `components/ui/date-picker.tsx`   |
| 8.8 | Testear en diferentes viewports          | Todas las paginas                 |

**Breakpoints a verificar:**

- Mobile: 320px - 480px
- Tablet: 768px
- Desktop: 1024px+

**Patrones responsive a aplicar:**

1. **Tablas**: Scroll horizontal en movil o convertir a cards
2. **Sidebar**: Drawer/sheet en movil con hamburger menu
3. **Forms**: Stack vertical, inputs full-width
4. **Modales**: Full-screen en movil
5. **Graficos**: Reducir altura, ocultar leyendas menos importantes

---

### Fase 9: Rutas de Conversion Alternativas (COP-VES via USDT)

**Objetivo:** Permitir conversion COP-VES usando USDT como intermediario ademas de USD

| #   | Tarea                                              | Archivos                                       |
| --- | -------------------------------------------------- | ---------------------------------------------- |
| 9.1 | Crear funcion para calcular ruta via USDT          | `lib/currency-utils.ts`                        |
| 9.2 | Modificar conversion para soportar multiples rutas | `lib/currency-utils.ts`                        |
| 9.3 | Agregar UI para mostrar ambas tasas en dashboard   | `app/dashboard/_components/`                   |
| 9.4 | Mostrar comparacion de rutas en pagina de tasas    | `app/dashboard/exchange-rates/page.tsx`        |
| 9.5 | Permitir elegir ruta preferida en settings         | `app/dashboard/settings/page.tsx`              |
| 9.6 | Guardar preferencia de ruta en UserConfig          | `prisma/schema.prisma`, `app/api/user-config/` |

**Rutas de conversion:**

```
Ruta 1 (Actual - USD):
COP -> USD (tasa oficial) -> VES (tasa oficial/Binance)
Ejemplo: 4,000,000 COP / 4,200 = 952.38 USD * 85 = 80,952 VES

Ruta 2 (Nueva - USDT):
COP -> USDT (Binance P2P) -> VES (Binance P2P)
Ejemplo: 4,000,000 COP / 4,150 = 963.86 USDT * 83 = 80,000 VES
```

**UI propuesta para comparacion:**

```
┌─────────────────────────────────────────────┐
│ Conversion COP -> VES                       │
├─────────────────────────────────────────────┤
│ Via USD (Oficial):     1 COP = 0.0202 VES   │
│ Via USDT (Binance):    1 COP = 0.0200 VES   │
├─────────────────────────────────────────────┤
│ Diferencia: 1% a favor de USDT              │
└─────────────────────────────────────────────┘
```

**Cambios en UserConfig:**

```prisma
model UserConfig {
  // ... campos existentes
  preferredConversionRoute  String?  @default("usd") // "usd" | "usdt"
}
```

---

## Archivos Criticos

| Archivo                                    | Cambios                       |
| ------------------------------------------ | ----------------------------- |
| `prisma/schema.prisma`                     | jobId opcional en Income      |
| `app/api/incomes/schema.ts`                | jobId opcional                |
| `app/api/incomes/service.ts`               | Validacion condicional de job |
| `app/dashboard/incomes/_components/`       | Trabajo opcional en form      |
| `components/ui/calendar.tsx`               | Layout con flechas arriba     |
| `app/api/budgets/schema.ts`                | Fix validacion targetAmount   |
| `components/ui/progress-bar.tsx`           | NUEVO - Barra de progreso     |
| `components/layout/progress-provider.tsx`  | NUEVO - Provider de progreso  |
| `lib/formatters.ts`                        | Espacio en formatCurrency     |
| `components/inventory/consume-modal.tsx`   | NUEVO - Modal de consumo      |
| `app/api/inventory-items/consume/route.ts` | NUEVO - Endpoint consumo      |
| `lib/currency-utils.ts`                    | Rutas de conversion multiples |
| `app/dashboard/exchange-rates/page.tsx`    | Comparacion de rutas          |

---

## Migracion de Base de Datos

```bash
yarn db:generate
yarn db:push
```

**Cambios en schema:**

- `Income.jobId` pasa de `String` a `String?`
- Datos existentes: Los ingresos existentes mantienen su jobId
- `UserConfig.preferredConversionRoute` nuevo campo opcional

---

## Dependencias Nuevas

```bash
yarn add next-nprogress-bar
# o alternativamente
yarn add nprogress @types/nprogress
```

---

## Verificacion

### Ingresos Extra

1. Crear ingreso sin seleccionar trabajo - funciona
2. Descripcion opcional visible
3. Tabla muestra "Ingreso Extra" para ingresos sin job
4. Editar ingreso existente - job preseleccionado

### DatePicker

5. Flechas de navegacion arriba del calendario
6. Dias ligeramente mas pequenos
7. No hay solapamiento de elementos

### Presupuestos

8. Crear budget sin targetAmount - sin error
9. Budget sin objetivo muestra solo monto actual
10. Budget con objetivo muestra barra de progreso

### Estado de Carga

11. Barra azul aparece al navegar entre paginas
12. Barra desaparece al completar la carga

### Inventory Categories

13. Crear item - categorias se actualizan
14. Editar item - categorias se actualizan

### Precio Est Spacing

15. Columna muestra "VES 0" con espacio
16. Todas las paginas muestran formato correcto

### Modal de Consumo

17. Accesible desde Dashboard (Quick Actions)
18. Accesible desde pagina de Inventario
19. Seleccionar multiples productos
20. Cantidades se reducen correctamente
21. Shopping list se actualiza

### Responsive

22. Sidebar funciona en movil (drawer)
23. Tablas tienen scroll o cards en movil
24. Formularios se ven bien en movil
25. Modales full-screen en movil
26. Graficos legibles en movil

### Rutas de Conversion

27. Conversion COP-VES via USD funciona
28. Conversion COP-VES via USDT funciona
29. Comparacion de rutas visible en dashboard
30. Preferencia de ruta guardada en settings

---

## Orden de Implementacion Sugerido

1. **Fase 3**: Fix budget targetAmount (bug critico)
2. **Fase 5**: Query invalidation (fix rapido)
3. **Fase 6**: Precio Est spacing (fix rapido)
4. **Fase 2**: DatePicker flechas
5. **Fase 1**: Ingresos Extra (feature principal)
6. **Fase 4**: Estado de carga (UX)
7. **Fase 7**: Modal de consumo (feature principal)
8. **Fase 9**: Rutas de conversion alternativas
9. **Fase 8**: Responsive (revision final)

---

## Estimacion de Complejidad

| Fase                      | Complejidad | Archivos          |
| ------------------------- | ----------- | ----------------- |
| Fase 1 (Ingresos Extra)   | Alta        | 8 archivos        |
| Fase 2 (DatePicker)       | Media       | 2 archivos        |
| Fase 3 (Budget fix)       | Baja        | 3 archivos        |
| Fase 4 (Loading)          | Media       | 4 archivos nuevos |
| Fase 5 (Query inv.)       | Baja        | 2 archivos        |
| Fase 6 (Spacing)          | Baja        | 2 archivos        |
| Fase 7 (Consumo)          | Alta        | 5 archivos nuevos |
| Fase 8 (Responsive)       | Alta        | 15+ archivos      |
| Fase 9 (Rutas Conversion) | Media       | 6 archivos        |

---

_WalletWise v1.4.0 - Mejoras y Nuevas Funcionalidades (Completado)_
