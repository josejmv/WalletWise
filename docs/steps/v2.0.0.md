# WalletWise v2.0.0

> Multi-User Edition con Autenticacion

**Estado:** Planificado

---

## Objetivo

Transformar WalletWise de una aplicacion single-user a una plataforma multi-usuario donde cada persona pueda crear su cuenta, iniciar sesion y gestionar sus finanzas de forma independiente y segura.

---

## Nuevas Features

### 0. Landing Page Publica

| Feature      | Descripcion                                       |
| ------------ | ------------------------------------------------- |
| Hero Section | Titulo principal con propuesta de valor y CTA     |
| Features     | Seccion mostrando las funcionalidades principales |
| Screenshots  | Capturas de pantalla del dashboard                |
| Pricing      | Planes y precios (si aplica)                      |
| Testimonials | Testimonios de usuarios (futuro)                  |
| CTA Final    | Llamada a accion para registro                    |
| Footer       | Links legales, redes sociales, contacto           |

**Ruta:** `/` (homepage publica)

**Estructura de archivos:**

```
app/
├── page.tsx              # Landing page publica
├── layout.tsx            # Layout sin sidebar
├── (marketing)/          # Rutas publicas adicionales
│   ├── pricing/
│   ├── features/
│   └── about/
└── dashboard/            # App privada (requiere auth)
    ├── layout.tsx        # Layout con sidebar
    └── ...
```

**Componentes sugeridos:**

```
components/
├── landing/
│   ├── hero.tsx          # Seccion principal
│   ├── features.tsx      # Grid de features
│   ├── screenshots.tsx   # Carousel de capturas
│   ├── pricing.tsx       # Tabla de precios
│   ├── testimonials.tsx  # Testimonios
│   ├── cta.tsx           # Call to action
│   └── footer.tsx        # Footer publico
└── ui/
    └── ...
```

**Flujo de usuario:**

```
Usuario no autenticado:
  / (landing) -> /auth/login -> /dashboard

Usuario autenticado:
  / (landing) -> redirect -> /dashboard
```

---

### 1. Sistema de Autenticacion

| Feature            | Descripcion                          |
| ------------------ | ------------------------------------ |
| Registro           | Crear cuenta con email y password    |
| Login              | Iniciar sesion con credenciales      |
| Logout             | Cerrar sesion de forma segura        |
| Forgot Password    | Recuperacion de contraseña via email |
| Email Verification | Verificar email al registrarse       |
| Session Management | Manejo de sesiones con tokens        |

### 2. Multi-Usuario

| Feature                | Descripcion                            |
| ---------------------- | -------------------------------------- |
| Aislamiento de Datos   | Cada usuario solo ve sus propios datos |
| Perfil de Usuario      | Nombre, avatar, preferencias           |
| Configuracion Personal | Moneda por defecto, idioma, tema       |
| Eliminacion de Cuenta  | Borrar cuenta y todos los datos        |

### 3. Seguridad

| Feature          | Descripcion                     |
| ---------------- | ------------------------------- |
| Password Hashing | bcrypt para almacenar passwords |
| JWT Tokens       | Autenticacion stateless         |
| CSRF Protection  | Proteccion contra ataques CSRF  |
| Rate Limiting    | Limitar intentos de login       |
| Secure Cookies   | HttpOnly, Secure, SameSite      |

---

## Stack Recomendado

### Opcion A: NextAuth.js (Recomendada)

```
NextAuth.js v5 (Auth.js)
├── Providers: Credentials, Google, GitHub
├── Adapters: Prisma Adapter
├── Session: JWT o Database
└── Callbacks: signIn, session, jwt
```

**Ventajas:**

- Integracion nativa con Next.js
- Soporte para OAuth providers
- Adapter oficial para Prisma
- Manejo de sesiones built-in

**Dependencias:**

```bash
npm install next-auth @auth/prisma-adapter
```

### Opcion B: Clerk

```
Clerk
├── Componentes: SignIn, SignUp, UserButton
├── Middleware: authMiddleware
├── Hooks: useUser, useAuth
└── API: currentUser()
```

**Ventajas:**

- UI pre-construida
- Muy facil de implementar
- Dashboard de administracion
- MFA incluido

**Dependencias:**

```bash
npm install @clerk/nextjs
```

### Opcion C: Custom Auth

```
Custom Implementation
├── bcrypt (password hashing)
├── jose (JWT)
├── Middleware personalizado
└── API routes propias
```

**Ventajas:**

- Control total
- Sin dependencias externas
- Personalizable 100%

---

## Cambios en el Schema de Prisma

```prisma
// Nuevo modelo User
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  password      String?   // null si usa OAuth
  name          String?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relaciones - todas las entidades del usuario
  accounts      Account[]
  jobs          Job[]
  incomes       Income[]
  expenses      Expense[]
  transfers     Transfer[]
  budgets       Budget[]
  categories    Category[]
  inventoryItems InventoryItem[]

  // Para NextAuth
  authAccounts  AuthAccount[]
  sessions      Session[]
}

// Para OAuth providers (NextAuth)
model AuthAccount {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
```

### Migracion de Entidades Existentes

Agregar `userId` a todas las entidades:

```prisma
model Account {
  id        String   @id @default(cuid())
  userId    String   // NUEVO
  name      String
  // ... resto de campos

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Income {
  id        String   @id @default(cuid())
  userId    String   // NUEVO
  // ... resto de campos

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Mismo patron para: Expense, Transfer, Job, Budget, Category, etc.
```

---

## Cambios en la Arquitectura

### Middleware de Autenticacion

```typescript
// middleware.ts
import { auth } from "@/lib/auth";

export default auth((req) => {
  const isLoggedIn = !!req.auth;
  const isAuthPage = req.nextUrl.pathname.startsWith("/auth");
  const isApiRoute = req.nextUrl.pathname.startsWith("/api");
  const isPublicApi = req.nextUrl.pathname.startsWith("/api/auth");

  // Redirigir a login si no esta autenticado
  if (!isLoggedIn && !isAuthPage && !isPublicApi) {
    return Response.redirect(new URL("/auth/login", req.nextUrl));
  }

  // Redirigir a dashboard si ya esta logueado
  if (isLoggedIn && isAuthPage) {
    return Response.redirect(new URL("/", req.nextUrl));
  }
});

export const config = {
  matcher: ["/((?!_next/static|_next/image|favicon.ico).*)"],
};
```

### Filtrado por Usuario en Repositories

```typescript
// app/api/expenses/repository.ts
export async function findAll(userId: string, filters?: ExpenseFilters) {
  return prisma.expense.findMany({
    where: {
      userId, // NUEVO - filtrar por usuario
      ...buildWhereClause(filters),
    },
    include: { category: true, account: true, currency: true },
    orderBy: { date: "desc" },
  });
}

export async function create(userId: string, data: CreateExpenseInput) {
  return prisma.expense.create({
    data: {
      ...data,
      userId, // NUEVO - asociar al usuario
    },
  });
}
```

### Obtencion del Usuario en API Routes

```typescript
// app/api/expenses/route.ts
import { auth } from "@/lib/auth";

export async function GET(request: Request) {
  const session = await auth();
  if (!session?.user?.id) {
    return NextResponse.json(
      { success: false, error: "No autorizado" },
      { status: 401 },
    );
  }

  const expenses = await getExpenses(session.user.id, filters);
  return NextResponse.json({ success: true, data: expenses });
}
```

---

## Nuevas Paginas

### Rutas de Autenticacion

```
app/
├── auth/
│   ├── login/
│   │   └── page.tsx       # Formulario de login
│   ├── register/
│   │   └── page.tsx       # Formulario de registro
│   ├── forgot-password/
│   │   └── page.tsx       # Recuperar contraseña
│   ├── reset-password/
│   │   └── page.tsx       # Nueva contraseña
│   └── verify-email/
│       └── page.tsx       # Verificar email
```

### Pagina de Perfil

```
app/
├── (dashboard)/
│   └── settings/
│       ├── page.tsx           # Configuracion general
│       ├── profile/
│       │   └── page.tsx       # Editar perfil
│       ├── security/
│       │   └── page.tsx       # Cambiar password
│       └── danger/
│           └── page.tsx       # Eliminar cuenta
```

---

## Componentes Nuevos

### Auth Components

```typescript
// components/auth/login-form.tsx
// components/auth/register-form.tsx
// components/auth/forgot-password-form.tsx
// components/auth/social-buttons.tsx
```

### User Components

```typescript
// components/user/user-avatar.tsx
// components/user/user-menu.tsx
// components/user/user-profile-form.tsx
```

### Layout Updates

```typescript
// components/layout/header.tsx
// - Agregar UserMenu con avatar y dropdown
// - Mostrar nombre del usuario
// - Boton de logout
```

---

## Fases de Implementacion

### Fase 0: Landing Page (Prioridad Alta)

| #   | Tarea                                | Complejidad |
| --- | ------------------------------------ | ----------- |
| 0.1 | Crear layout publico sin sidebar     | Baja        |
| 0.2 | Implementar Hero section             | Baja        |
| 0.3 | Implementar Features section         | Baja        |
| 0.4 | Implementar Screenshots/Demo section | Media       |
| 0.5 | Implementar CTA y Footer             | Baja        |
| 0.6 | Agregar animaciones (Framer Motion)  | Media       |
| 0.7 | Responsive design para mobile        | Media       |

### Fase 1: Setup Autenticacion (Prioridad Alta)

| #   | Tarea                                      | Complejidad |
| --- | ------------------------------------------ | ----------- |
| 1.1 | Instalar NextAuth.js y Prisma Adapter      | Baja        |
| 1.2 | Configurar providers (Credentials)         | Media       |
| 1.3 | Crear modelos User, Session, etc en Prisma | Baja        |
| 1.4 | Crear paginas de login y registro          | Media       |
| 1.5 | Implementar middleware de proteccion       | Media       |
| 1.6 | Agregar UserMenu al header                 | Baja        |

### Fase 2: Migracion Multi-Usuario (Prioridad Alta)

| #   | Tarea                                | Complejidad |
| --- | ------------------------------------ | ----------- |
| 2.1 | Agregar userId a todas las entidades | Media       |
| 2.2 | Crear migracion de base de datos     | Media       |
| 2.3 | Actualizar todos los repositories    | Alta        |
| 2.4 | Actualizar todos los services        | Alta        |
| 2.5 | Actualizar todas las API routes      | Alta        |
| 2.6 | Migrar datos existentes (si aplica)  | Media       |

### Fase 3: Features de Usuario (Prioridad Media)

| #   | Tarea                       | Complejidad |
| --- | --------------------------- | ----------- |
| 3.1 | Pagina de perfil de usuario | Baja        |
| 3.2 | Cambio de contraseña        | Baja        |
| 3.3 | Recuperacion de contraseña  | Media       |
| 3.4 | Verificacion de email       | Media       |
| 3.5 | Eliminacion de cuenta       | Media       |

### Fase 4: OAuth Providers (Prioridad Baja)

| #   | Tarea                     | Complejidad |
| --- | ------------------------- | ----------- |
| 4.1 | Configurar Google OAuth   | Baja        |
| 4.2 | Configurar GitHub OAuth   | Baja        |
| 4.3 | UI de conexion de cuentas | Media       |

---

## Consideraciones de Seguridad

### Checklist de Seguridad

- [ ] Passwords hasheados con bcrypt (min 10 rounds)
- [ ] JWT con expiracion corta (15 min) + refresh tokens
- [ ] HTTPS obligatorio en produccion
- [ ] Cookies HttpOnly, Secure, SameSite=Strict
- [ ] Rate limiting en login (max 5 intentos/minuto)
- [ ] Validacion de email antes de activar cuenta
- [ ] Logs de actividad de autenticacion
- [ ] CSRF tokens en formularios
- [ ] Headers de seguridad (helmet.js)
- [ ] Sanitizacion de inputs

### Variables de Entorno Nuevas

```env
# NextAuth
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=your-secret-key-here

# OAuth (opcional)
GOOGLE_CLIENT_ID=
GOOGLE_CLIENT_SECRET=
GITHUB_CLIENT_ID=
GITHUB_CLIENT_SECRET=

# Email (para verificacion y recovery)
SMTP_HOST=
SMTP_PORT=
SMTP_USER=
SMTP_PASS=
EMAIL_FROM=noreply@walletwise.app
```

---

## Testing

### Tests de Autenticacion

```typescript
// __tests__/auth/login.test.ts
describe("Login", () => {
  it("should login with valid credentials");
  it("should reject invalid password");
  it("should reject non-existent user");
  it("should rate limit after 5 attempts");
});

// __tests__/auth/register.test.ts
describe("Register", () => {
  it("should create user with valid data");
  it("should reject duplicate email");
  it("should validate password strength");
  it("should send verification email");
});
```

### Tests de Aislamiento de Datos

```typescript
// __tests__/isolation.test.ts
describe("Data Isolation", () => {
  it("user A cannot see user B expenses");
  it("user A cannot modify user B data");
  it("deleting user deletes all their data");
});
```

---

## Estimacion de Esfuerzo

| Fase      | Tareas           | Complejidad | Estimacion     |
| --------- | ---------------- | ----------- | -------------- |
| Fase 0    | Landing Page     | Media       | 2-3 dias       |
| Fase 1    | Setup Auth       | Media       | 2-3 dias       |
| Fase 2    | Multi-Usuario    | Alta        | 3-5 dias       |
| Fase 3    | Features Usuario | Media       | 2-3 dias       |
| Fase 4    | OAuth            | Baja        | 1-2 dias       |
| Testing   | Pruebas          | Media       | 2-3 dias       |
| **Total** |                  |             | **12-19 dias** |

---

## Dependencias Nuevas

```json
{
  "dependencies": {
    "next-auth": "^5.0.0",
    "@auth/prisma-adapter": "^2.0.0",
    "bcryptjs": "^2.4.3",
    "framer-motion": "^11.0.0"
  },
  "devDependencies": {
    "@types/bcryptjs": "^2.4.6"
  }
}
```

---

## Notas Finales

### Recomendaciones

1. **Empezar con Credentials Provider** - Es mas simple y permite control total
2. **Agregar OAuth despues** - Una vez el flujo basico funcione
3. **Testing exhaustivo** - La seguridad es critica
4. **Documentar API** - Actualizar docs con nuevos endpoints de auth

### Breaking Changes

- Todos los endpoints ahora requieren autenticacion
- La estructura de la base de datos cambia significativamente
- Los backups existentes no seran compatibles sin migracion

### Retrocompatibilidad

Para usuarios existentes de v1.0.0:

1. Crear script de migracion que asigne todos los datos a un usuario por defecto
2. Forzar cambio de contraseña en primer login
3. Documentar proceso de migracion

---

_Version 2.0.0 - WalletWise Multi-User Edition (Planificado)_
