# WalletWise v1.1.0

> Mejoras y Nuevas Features

**Estado:** Planificado

---

## Objetivo

Agregar mejoras incrementales y nuevas funcionalidades a WalletWise sin romper compatibilidad con v1.0.0. Incluye integracion con Binance P2P, mejoras de UX y optimizaciones.

---

## Nuevas Features

### 1. Tasas de Cambio Binance P2P

| Feature              | Descripcion                                        |
| -------------------- | -------------------------------------------------- |
| USDT como Currency   | Agregar USDT (Tether) como moneda del sistema      |
| Fuente de Tasa       | Campo `source` para diferenciar origen de la tasa  |
| Sync Binance P2P     | Sincronizar tasas USDT/VES, USDT/COP desde Binance |
| Comparador de Tasas  | UI para comparar tasa oficial vs tasa Binance      |
| Historial por Fuente | Ver historial de tasas filtrado por fuente         |

**API de Binance P2P:**

```
POST https://p2p.binance.com/bapi/c2c/v2/friendly/c2c/adv/search

Body: {
  "fiat": "VES",        // Moneda fiat (VES, COP, etc.)
  "asset": "USDT",      // Criptomoneda
  "tradeType": "SELL",  // SELL = precio venta USDT, BUY = precio compra
  "page": 1,
  "rows": 10,
  "payTypes": []        // Filtro por metodo de pago (opcional)
}
```

**Respuesta:**

```json
{
  "data": [
    {
      "adv": {
        "price": "38.50",
        "minSingleTransAmount": "100",
        "maxSingleTransAmount": "5000"
      },
      "advertiser": {
        "nickName": "Trader123",
        "monthOrderCount": 500
      }
    }
  ]
}
```

**Cambios en Schema Prisma:**

```prisma
// Agregar enum para fuentes de tasas
enum ExchangeRateSource {
  official    // API oficial (er-api.com)
  binance     // Binance P2P
  manual      // Ingresada manualmente
}

model ExchangeRate {
  id             String              @id @default(uuid())
  fromCurrencyId String
  toCurrencyId   String
  rate           Decimal             @db.Decimal(18, 8)
  source         ExchangeRateSource  @default(official)  // NUEVO
  fetchedAt      DateTime            @default(now())

  // Relations
  fromCurrency Currency @relation("FromCurrency", fields: [fromCurrencyId], references: [id])
  toCurrency   Currency @relation("ToCurrency", fields: [toCurrencyId], references: [id])

  createdAt DateTime @default(now())

  @@index([fromCurrencyId, toCurrencyId])
  @@index([fetchedAt])
  @@index([source])  // NUEVO
  @@map("exchange_rates")
}
```

**Seed de USDT:**

```typescript
// prisma/seed.ts
const currencies = [
  { code: "USD", name: "Dolar estadounidense", symbol: "$", isBase: true },
  { code: "COP", name: "Peso colombiano", symbol: "COP$", isBase: false },
  { code: "VES", name: "Bolivar venezolano", symbol: "Bs.", isBase: false },
  { code: "USDT", name: "Tether", symbol: "USDT", isBase: false }, // NUEVO
];
```

**Nuevos Endpoints:**

| Metodo | Endpoint                             | Descripcion                     |
| ------ | ------------------------------------ | ------------------------------- |
| POST   | `/api/exchange-rates/sync/binance`   | Sincronizar tasas desde Binance |
| GET    | `/api/exchange-rates?source=binance` | Filtrar por fuente              |

**UI Actualizada:**

- Selector de fuente en pagina de Exchange Rates
- Boton "Sync Binance" junto a "Sync Official"
- Tabla comparativa: Tasa Oficial vs Tasa Binance
- Badge indicando fuente de cada tasa

---

### 2. [Placeholder para proxima feature]

_Agregar aqui la siguiente mejora que identifiques_

---

### 3. [Placeholder para proxima feature]

_Agregar aqui la siguiente mejora que identifiques_

---

## Fases de Implementacion

### Fase 1: Binance P2P Integration

| #   | Tarea                                      | Complejidad |
| --- | ------------------------------------------ | ----------- |
| 1.1 | Agregar enum `ExchangeRateSource` a Prisma | Baja        |
| 1.2 | Agregar campo `source` a ExchangeRate      | Baja        |
| 1.3 | Crear migracion de base de datos           | Baja        |
| 1.4 | Agregar USDT al seed de currencies         | Baja        |
| 1.5 | Crear servicio de sync con Binance P2P API | Media       |
| 1.6 | Crear endpoint POST /sync/binance          | Baja        |
| 1.7 | Actualizar UI con selector de fuente       | Media       |
| 1.8 | Agregar comparador de tasas en UI          | Media       |

### Fase 2: [Proxima Feature]

_Definir tareas cuando se agregue la feature_

---

## Cambios en API Existente

### Exchange Rates

**Antes (v1.0.0):**

```typescript
interface ExchangeRate {
  id: string;
  fromCurrencyId: string;
  toCurrencyId: string;
  rate: number;
  fetchedAt: Date;
}
```

**Despues (v1.1.0):**

```typescript
interface ExchangeRate {
  id: string;
  fromCurrencyId: string;
  toCurrencyId: string;
  rate: number;
  source: "official" | "binance" | "manual"; // NUEVO
  fetchedAt: Date;
}
```

### Filtros Nuevos

```typescript
interface ExchangeRateFilters {
  fromCurrencyId?: string;
  toCurrencyId?: string;
  source?: "official" | "binance" | "manual"; // NUEVO
  startDate?: Date;
  endDate?: Date;
}
```

---

## Retrocompatibilidad

| Aspecto       | Compatibilidad | Notas                                    |
| ------------- | -------------- | ---------------------------------------- |
| API Endpoints | 100%           | Nuevos endpoints, existentes sin cambios |
| Base de Datos | 100%           | Campo `source` tiene default "official"  |
| Frontend      | 100%           | UI existente sigue funcionando           |
| Backups       | 100%           | Formato JSON compatible                  |

---

## Dependencias Nuevas

```json
{
  "dependencies": {
    // No se requieren dependencias nuevas para Binance API
    // Se usa fetch nativo de Node.js
  }
}
```

---

## Consideraciones

### Rate Limiting de Binance

- Binance P2P API tiene limites de requests
- Implementar cache de 5-10 minutos para evitar bloqueos
- Mostrar `fetchedAt` para que el usuario sepa que tan reciente es la tasa

### Precio Promedio vs Mejor Precio

- La API devuelve multiples ofertas ordenadas por precio
- Opciones:
  - Usar el mejor precio (primer resultado)
  - Calcular promedio de top 5-10 ofertas
  - Guardar ambos (bestPrice, avgPrice)

### Trade Type

- `SELL`: Precio al que venden USDT (usuario compra USDT con fiat)
- `BUY`: Precio al que compran USDT (usuario vende USDT por fiat)
- Considerar guardar ambas direcciones

---

## Notas

- Esta version es retrocompatible con v1.0.0
- No requiere migracion de datos existentes
- El campo `source` defaultea a "official" para tasas existentes

---

_Version 1.1.0 - WalletWise Mejoras Incrementales (Planificado)_
