# WalletWise v1.1.0

> Mejoras Incrementales - UX, Tasas de Cambio, Crypto y Personalizacion

**Estado:** Planificado

---

## Objetivo

Agregar mejoras significativas en UX, sistema de tasas de cambio, soporte crypto, y personalizacion del sidebar. Todas las mejoras son retrocompatibles con v1.0.0.

---

## Nuevas Features

### 1. Sidebar Personalizable

| Feature                  | Descripcion                                            |
| ------------------------ | ------------------------------------------------------ |
| Dropdowns por contexto   | Agrupar items relacionados (Transacciones, Inventario) |
| Drag & Drop              | Reordenar items y grupos arrastrando                   |
| Crear/eliminar grupos    | Usuario puede crear sus propias categorias             |
| Mover items entre grupos | Flexibilidad total en la organizacion                  |
| Persistencia en BD       | Configuracion guardada en base de datos                |

**Estructura por defecto:**

```
Dashboard
-----------------
v Transacciones
  - Ingresos
  - Gastos
  - Transferencias
-----------------
v Finanzas
  - Cuentas
  - Presupuestos
  - Trabajos
-----------------
v Inventario
  - Items
  - Categorias
  - Historial Precios
  - Lista de Compras
-----------------
v Configuracion
  - Monedas
  - Tasas de Cambio
  - Categorias Gastos
  - Tipos de Cuenta
-----------------
Reportes
-----------------
[Footer]
Backup | Ajustes
```

---

### 2. Sistema de Tasas de Cambio Mejorado

| Feature               | Descripcion                                       |
| --------------------- | ------------------------------------------------- |
| Multiples fuentes     | API oficial (er-api.com) + Binance P2P            |
| Cooldown de sync      | Minimo 6 horas entre sincronizaciones             |
| Display completo      | Tasa oficial + custom + diferencia (ahorro/extra) |
| Tasa manual requerida | Si no hay tasa, forzar ingreso manual             |
| Historial por fuente  | Graficos separados + comparativo                  |

**API de Binance P2P:**

```
POST https://p2p.binance.com/bapi/c2c/v2/friendly/c2c/adv/search

Body: {
  "fiat": "VES",
  "asset": "USDT",
  "tradeType": "SELL",
  "page": 1,
  "rows": 10
}
```

---

### 3. Soporte Criptomonedas

| Feature            | Descripcion                               |
| ------------------ | ----------------------------------------- |
| Monedas soportadas | USDT, BTC, ETH, BNB, SOL                  |
| Tasas Binance P2P  | Sync de todas las cryptos a VES, COP, USD |
| Cuentas crypto     | Crear cuentas con moneda USDT, BTC, etc.  |

---

### 4. Budgets Mejorados

| Feature               | Descripcion                                     |
| --------------------- | ----------------------------------------------- |
| Bloqueo de saldo      | Ambos tipos (goal/envelope) bloquean saldo      |
| Contribuciones        | Reducen balance de cuenta automaticamente       |
| Retiros               | Transfer especial budget -> cuenta              |
| Vista cuenta mejorada | Total / Disponible / Bloqueado con barra visual |
| Desglose expandible   | Ver que budgets tienen el dinero bloqueado      |

---

### 5. Formularios Inteligentes

| Feature          | Descripcion                                       |
| ---------------- | ------------------------------------------------- |
| Auto-currency    | Seleccionar cuenta auto-selecciona su moneda      |
| Display de tasas | Tasa oficial + custom + monto convertido + ahorro |
| Inline create    | Boton "+" para crear entidades sin salir del form |
| Conversion auto  | Si moneda difiere de cuenta, convertir al guardar |

---

### 6. Dashboard Mejorado

| Feature             | Descripcion                                      |
| ------------------- | ------------------------------------------------ |
| Quick Actions       | Modales para crear Ingreso, Gasto, Transferencia |
| Widget tasas        | Tasas actuales USD/VES, USD/COP, etc.            |
| Widget ahorro       | Total ahorrado por tasas custom vs oficial       |
| Grafico historico   | Lineas + puntos, ultimos 30 dias                 |
| Grafico comparativo | Comparar fuentes (oficial vs Binance)            |

---

### 7. Settings

| Feature         | Descripcion                                   |
| --------------- | --------------------------------------------- |
| Moneda base     | Selector de moneda para totales del dashboard |
| Formato fecha   | DD/MM/YYYY, MM/DD/YYYY, YYYY-MM-DD            |
| Formato numeros | ES-CO (1.234,56) o EN-US (1,234.56)           |
| Tema            | Sistema / Claro / Oscuro                      |
| Sidebar config  | UI para personalizar el sidebar               |

---

### 8. Historial con Tasas

| Feature              | Descripcion                                   |
| -------------------- | --------------------------------------------- |
| Columna dedicada     | Mostrar tasa usada con badge (Oficial/Custom) |
| Detalles expandibles | Click para ver conversion completa            |
| Diferencia colorada  | Verde = ahorro, Rojo = gasto extra            |

---

## Cambios en Schema Prisma

### Nuevos Enums

```prisma
enum ExchangeRateSource {
  official
  binance
  manual
}

enum TransferType {
  account_to_account
  account_to_budget
  budget_to_account
}
```

### Modelo ExchangeRate (Actualizado)

```prisma
model ExchangeRate {
  id             String              @id @default(uuid())
  fromCurrencyId String
  toCurrencyId   String
  rate           Decimal             @db.Decimal(18, 8)
  source         ExchangeRateSource  @default(official)
  fetchedAt      DateTime            @default(now())

  fromCurrency Currency @relation("FromCurrency", fields: [fromCurrencyId], references: [id])
  toCurrency   Currency @relation("ToCurrency", fields: [toCurrencyId], references: [id])

  createdAt DateTime @default(now())

  @@index([fromCurrencyId, toCurrencyId])
  @@index([fetchedAt])
  @@index([source])
  @@map("exchange_rates")
}
```

### Modelo Transfer (Actualizado)

```prisma
model Transfer {
  id            String       @id @default(uuid())
  type          TransferType @default(account_to_account)
  fromAccountId String?
  toAccountId   String?
  fromBudgetId  String?
  toBudgetId    String?
  amount        Decimal      @db.Decimal(18, 2)
  currencyId    String
  exchangeRate  Decimal?     @db.Decimal(18, 8)
  officialRate  Decimal?     @db.Decimal(18, 8)
  customRate    Decimal?     @db.Decimal(18, 8)
  date          DateTime     @default(now())
  description   String?

  fromAccount Account?  @relation("FromAccount", fields: [fromAccountId], references: [id])
  toAccount   Account?  @relation("ToAccount", fields: [toAccountId], references: [id])
  fromBudget  Budget?   @relation("FromBudget", fields: [fromBudgetId], references: [id])
  toBudget    Budget?   @relation("ToBudget", fields: [toBudgetId], references: [id])
  currency    Currency  @relation(fields: [currencyId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([fromAccountId])
  @@index([toAccountId])
  @@index([fromBudgetId])
  @@index([toBudgetId])
  @@index([date])
  @@index([type])
  @@map("transfers")
}
```

### Modelo Budget (Actualizado)

```prisma
model Budget {
  id            String       @id @default(uuid())
  name          String
  type          BudgetType
  targetAmount  Decimal      @db.Decimal(18, 2)
  currentAmount Decimal      @default(0) @db.Decimal(18, 2)
  currencyId    String
  accountId     String       // Ahora requerido para ambos tipos
  deadline      DateTime?
  status        BudgetStatus @default(active)

  currency        Currency             @relation(fields: [currencyId], references: [id])
  account         Account              @relation(fields: [accountId], references: [id])
  contributions   BudgetContribution[]
  transfersFrom   Transfer[]           @relation("FromBudget")
  transfersTo     Transfer[]           @relation("ToBudget")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("budgets")
}
```

### Nuevo Modelo: UserConfig

```prisma
model UserConfig {
  id              String   @id @default(uuid())
  baseCurrencyId  String
  dateFormat      String   @default("DD/MM/YYYY")
  numberFormat    String   @default("es-CO")
  theme           String   @default("system")
  sidebarConfig   Json     @default("[]")
  lastRateSyncAt  DateTime?

  baseCurrency Currency @relation(fields: [baseCurrencyId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_config")
}
```

### Nuevo Modelo: ExchangeRateSyncLog

```prisma
model ExchangeRateSyncLog {
  id         String              @id @default(uuid())
  source     ExchangeRateSource
  status     String
  message    String?
  ratesCount Int                 @default(0)
  syncedAt   DateTime            @default(now())

  @@index([source])
  @@index([syncedAt])
  @@map("exchange_rate_sync_logs")
}
```

---

## Fases de Implementacion

### Fase 1: Fixes Criticos (Prioridad Alta)

| Tarea | Descripcion                                    |
| ----- | ---------------------------------------------- |
| 1.1   | Crear pagina Settings con opciones basicas     |
| 1.2   | Agregar modelo UserConfig a Prisma             |
| 1.3   | CRUD para configuracion de usuario             |
| 1.4   | Fix error de categoria en inventario           |
| 1.5   | Limpiar seed (solo currencies + account types) |

### Fase 2: Sistema de Tasas de Cambio (Prioridad Alta)

| Tarea | Descripcion                                      |
| ----- | ------------------------------------------------ |
| 2.1   | Agregar ExchangeRateSource y ExchangeRateSyncLog |
| 2.2   | Componente ExchangeRateDisplay reutilizable      |
| 2.3   | Utilidades para fetch y calculo de diferencias   |
| 2.4   | Endpoint sync Binance P2P                        |
| 2.5   | Validar cooldown 6 horas en sync                 |

### Fase 3: Criptomonedas (Prioridad Alta)

| Tarea | Descripcion                              |
| ----- | ---------------------------------------- |
| 3.1   | Agregar USDT, BTC, ETH, BNB, SOL al seed |
| 3.2   | Cliente API Binance P2P                  |
| 3.3   | Implementar sync crypto/fiat             |

### Fase 4: Formularios con Tasas (Prioridad Alta)

| Tarea | Descripcion                           |
| ----- | ------------------------------------- |
| 4.1   | Expense form: auto-currency + tasas   |
| 4.2   | Income form: auto-currency + tasas    |
| 4.3   | Transfer form: tasas + tipos transfer |
| 4.4   | Modal para crear entidades in-form    |

### Fase 5: Budgets y Transferencias (Prioridad Alta)

| Tarea | Descripcion                            |
| ----- | -------------------------------------- |
| 5.1   | Actualizar Transfer y Budget en schema |
| 5.2   | Contribuciones que actualizan balance  |
| 5.3   | Soporte account/budget transfers       |
| 5.4   | UI para contribuir a budget            |
| 5.5   | UI para retirar de budget              |

### Fase 6: Vista de Cuentas Mejorada (Prioridad Media)

| Tarea | Descripcion                                |
| ----- | ------------------------------------------ |
| 6.1   | Card con barra visual disponible/bloqueado |
| 6.2   | Calcular saldo bloqueado por budgets       |
| 6.3   | Vista detalle con budgets relacionados     |

### Fase 7: Sidebar Personalizable (Prioridad Media)

| Tarea | Descripcion                            |
| ----- | -------------------------------------- |
| 7.1   | Refactor sidebar con dropdowns         |
| 7.2   | Componentes SidebarItem y SidebarGroup |
| 7.3   | Implementar drag-drop con dnd-kit      |
| 7.4   | UI para personalizar en Settings       |
| 7.5   | Hook para leer/actualizar config       |

### Fase 8: Dashboard Mejorado (Prioridad Media)

| Tarea | Descripcion                       |
| ----- | --------------------------------- |
| 8.1   | Quick actions con modales         |
| 8.2   | Widget tasas actuales             |
| 8.3   | Widget ahorro total               |
| 8.4   | Grafico historico lineas + puntos |
| 8.5   | Grafico comparacion fuentes       |

### Fase 9: Formato y UX (Prioridad Media)

| Tarea | Descripcion                        |
| ----- | ---------------------------------- |
| 9.1   | Formatters de fecha segun config   |
| 9.2   | Formatters de numeros segun config |
| 9.3   | Hook useUserConfig                 |
| 9.4   | Actualizar todas las paginas       |

### Fase 10: Historial con Tasas (Prioridad Baja)

| Tarea | Descripcion                        |
| ----- | ---------------------------------- |
| 10.1  | Columna tasas en expenses          |
| 10.2  | Columna tasas en incomes           |
| 10.3  | Columna tasas en transfers         |
| 10.4  | Popover con detalles de conversion |

---

## Seed Data

```typescript
const currencies = [
  // Fiat
  { code: "USD", name: "Dolar estadounidense", symbol: "$", isBase: true },
  { code: "COP", name: "Peso colombiano", symbol: "COP$", isBase: false },
  { code: "VES", name: "Bolivar venezolano", symbol: "Bs.", isBase: false },
  // Crypto
  { code: "USDT", name: "Tether", symbol: "USDT", isBase: false },
  { code: "BTC", name: "Bitcoin", symbol: "BTC", isBase: false },
  { code: "ETH", name: "Ethereum", symbol: "ETH", isBase: false },
  { code: "BNB", name: "Binance Coin", symbol: "BNB", isBase: false },
  { code: "SOL", name: "Solana", symbol: "SOL", isBase: false },
];

const accountTypes = [
  { name: "Cuenta Bancaria", type: "bank" },
  { name: "Efectivo", type: "cash" },
  { name: "Billetera Digital", type: "digital_wallet" },
  { name: "Tarjeta de Credito", type: "credit_card" },
];
```

---

## APIs Nuevas

| Endpoint                           | Metodo | Descripcion                   |
| ---------------------------------- | ------ | ----------------------------- |
| `/api/user-config`                 | GET    | Obtener configuracion actual  |
| `/api/user-config`                 | PUT    | Actualizar configuracion      |
| `/api/exchange-rates/sync/binance` | POST   | Sync tasas Binance P2P        |
| `/api/exchange-rates/sync/logs`    | GET    | Historial de sincronizaciones |
| `/api/accounts/[id]/blocked`       | GET    | Saldo bloqueado por budgets   |

---

## Componentes Nuevos

| Componente          | Descripcion                                |
| ------------------- | ------------------------------------------ |
| ExchangeRateDisplay | Muestra tasa oficial/custom con diferencia |
| InlineCreateModal   | Modal para crear entidades desde forms     |
| QuickActionButton   | Boton de accion rapida para dashboard      |
| SidebarGroup        | Dropdown colapsable del sidebar            |
| RateHistoryChart    | Grafico de lineas + puntos                 |
| RateComparisonChart | Grafico comparativo de fuentes             |
| AccountBalanceCard  | Card con barra visual                      |
| ContributeModal     | Modal para contribuir a budget             |
| WithdrawModal       | Modal para retirar de budget               |

---

## Dependencias Nuevas

```json
{
  "dependencies": {
    "@dnd-kit/core": "^6.0.0",
    "@dnd-kit/sortable": "^7.0.0"
  }
}
```

---

## Retrocompatibilidad

| Aspecto       | Compatibilidad | Notas                                    |
| ------------- | -------------- | ---------------------------------------- |
| API Endpoints | 100%           | Nuevos endpoints, existentes sin cambios |
| Base de Datos | 100%           | Campos nuevos tienen defaults            |
| Frontend      | 100%           | UI existente sigue funcionando           |
| Backups       | Separados      | Datos financieros vs configuracion       |

---

## Notas de Migracion

1. Ejecutar `prisma migrate` para nuevos modelos
2. Re-ejecutar seed para agregar cryptos y UserConfig
3. Datos existentes:
   - Transfers: type = "account_to_account"
   - ExchangeRates: source = "official"
   - Budgets: Requieren accountId (migrar o eliminar)

---

_Version 1.1.0 - WalletWise Mejoras Incrementales (Planificado)_
