# WalletWise v1.2.0

> Correcciones y Mejoras - Bugfixes y UX Improvements

**Version:** 1.2.0
**Estado:** Completado
**Fecha:** Enero 2026

---

## Descripcion

Version 1.2.0 corrige bugs criticos encontrados durante testing y mejora la experiencia de usuario. Prioridades:

1. Cache e invalidacion de queries
2. Sistema de tasas de cambio completo
3. Calculos y conversiones de monedas
4. Mejoras de UI

---

## Cambios Implementados

### Fase 1: Cache e Invalidacion de Queries

| Cambio         | Descripcion                                                           | Estado     |
| -------------- | --------------------------------------------------------------------- | ---------- |
| Gastos         | Invalidar `dashboard` y `accounts` al crear/editar/eliminar gastos    | Completado |
| Ingresos       | Invalidar `dashboard` y `accounts` al crear/editar/eliminar ingresos  | Completado |
| Transferencias | Invalidar `dashboard`, `accounts` y `budgets` al crear/eliminar       | Completado |
| Tasas          | Invalidar tanto `exchange-rates` como `exchange-rate` (hook singular) | Completado |
| Budgets        | Invalidar `dashboard`, `accounts` y `budgets` al contribuir/retirar   | Completado |

### Fase 2: Sistema de Tasas de Cambio

| Cambio                 | Descripcion                                            | Estado     |
| ---------------------- | ------------------------------------------------------ | ---------- |
| Boton Sincronizar Todo | Sincroniza oficial + Binance en una sola accion        | Completado |
| Botones individuales   | Oficial y Binance con sync separado                    | Completado |
| Columna Fuente         | Tabla muestra "Oficial", "Binance" o "Manual"          | Completado |
| Tasas inversas         | Generacion automatica de tasas inversas al sincronizar | Completado |
| Cooldown separado      | 6 horas independientes para oficial y Binance          | Completado |

### Fase 3: Calculos y Conversiones

| Cambio                  | Descripcion                                           | Estado     |
| ----------------------- | ----------------------------------------------------- | ---------- |
| `lib/currency-utils.ts` | Funciones centralizadas de conversion                 | Completado |
| KPIs                    | Convertir todos los montos a moneda base del usuario  | Completado |
| Tendencia mensual       | Convertir ingresos/gastos a moneda base               | Completado |
| Formula ahorro          | Fix: `savings = amount * (officialRate - customRate)` | Completado |
| Disponible              | Fix: `Math.max(0, balance - bloqueado)`               | Completado |

### Fase 4: Transacciones Recientes

| Cambio           | Descripcion                            | Estado     |
| ---------------- | -------------------------------------- | ---------- |
| Contribuciones   | Incluir en transacciones recientes     | Completado |
| Retiros          | Incluir en transacciones recientes     | Completado |
| Icono distintivo | Alcancia para operaciones de budget    | Completado |
| Filtro           | Mostrar solo dia actual y dia anterior | Completado |

### Fase 5: Tema (Persistencia)

| Cambio                | Descripcion                             | Estado     |
| --------------------- | --------------------------------------- | ---------- |
| Leer tema de BD       | Aplicar tema de UserConfig al cargar    | Completado |
| Sincronizar Header    | Guardar cambio de tema en BD            | Completado |
| Deteccion sistema     | Manejar `theme: "system"` correctamente | Completado |
| Script inicializacion | Evitar flash de tema incorrecto         | Completado |

### Fase 6: Formularios

| Cambio             | Descripcion                                    | Estado     |
| ------------------ | ---------------------------------------------- | ---------- |
| InlineAccountModal | Crear cuenta desde form de trabajo/presupuesto | Completado |
| Fix editar trabajo | Precargar moneda y cuenta seleccionadas        | Completado |
| Inputs monto       | Quitar valor 0 por defecto                     | Completado |

### Fase 7: UI - Cuentas y Categorias

| Cambio                 | Descripcion                                          | Estado     |
| ---------------------- | ---------------------------------------------------- | ---------- |
| Cuentas como tabla     | Nombre, Tipo, Moneda, Balance, Disponible, Bloqueado | Completado |
| Categorias expandibles | Colapsadas por defecto, click para expandir          | Completado |
| Modal edicion          | Para editar subcategorias                            | Completado |

### Fase 8: Inventario

| Cambio                  | Descripcion                      | Estado     |
| ----------------------- | -------------------------------- | ---------- |
| Categoria opcional      | Permitir productos sin categoria | Completado |
| Seccion "Sin categoria" | Agrupar productos sin categoria  | Completado |
| Price history endpoints | GET general y por item           | Completado |

### Fase 9: Shopping List Multi-Moneda

| Cambio           | Descripcion                                   | Estado     |
| ---------------- | --------------------------------------------- | ---------- |
| Select de moneda | Para costo estimado                           | Completado |
| Conversion       | Convertir cada producto a moneda seleccionada | Completado |
| Sin tasa         | Mostrar producto en moneda original           | Completado |

---

## Decisiones de Diseno

### Tasas de Cambio

- **Sincronizacion:** Boton "Sincronizar Todo" + botones individuales
- **Vista:** Una sola tabla con columna "Fuente"
- **Pares Binance:** Cryptos a Fiat + Crypto a Crypto
- **Bidireccional:** Calcular automaticamente la inversa
- **Cooldown:** Separado por fuente (6h independientes)

### Calculos

- **Formula ahorro:** Si `tasa_custom < tasa_oficial` = AHORRO (verde)
- **Disponible:** `balance_total - suma_budgets_bloqueados` (minimo 0)
- **Conversion:** Todos los montos se convierten a moneda base
- **Historico:** Las tasas guardadas en transacciones NO se actualizan

### UI

- **Tabla cuentas:** Nombre | Tipo | Moneda | Balance | Disponible | Bloqueado | Acciones
- **Categorias:** Tabla expandible, colapsadas por defecto
- **Inventario:** Categoria opcional, seccion "Sin categoria"
- **Shopping List:** Selector de moneda, conversion con indicador de items sin tasa

---

## Schema Updates

```prisma
model UserConfig {
  // ... campos existentes
  lastRateSyncAt     DateTime? // Legacy
  lastOfficialSyncAt DateTime? // Cooldown para API oficial
  lastBinanceSyncAt  DateTime? // Cooldown para Binance P2P
}

model InventoryItem {
  // ... campos existentes
  categoryId String? // Ahora opcional
  category   InventoryCategory? @relation(...)
}
```

---

## Archivos Nuevos

| Archivo                                               | Descripcion                           |
| ----------------------------------------------------- | ------------------------------------- |
| `lib/currency-utils.ts`                               | Funciones de conversion centralizadas |
| `components/inline-account-modal.tsx`                 | Modal para crear cuenta inline        |
| `app/api/inventory-items/price-history/route.ts`      | Endpoint historial de precios general |
| `app/api/inventory-items/[id]/price-history/route.ts` | Endpoint historial por item           |

## Archivos Modificados

| Archivo                                                       | Cambios                                     |
| ------------------------------------------------------------- | ------------------------------------------- |
| `app/api/dashboard/service.ts`                                | Conversiones, formula ahorro, transacciones |
| `app/api/dashboard/types.ts`                                  | Tipos para contribution/withdrawal          |
| `app/api/accounts/service.ts`                                 | Fix calculo disponible                      |
| `app/api/reports/service.ts`                                  | Conversiones a moneda base                  |
| `app/dashboard/expenses/page.tsx`                             | Invalidar queries                           |
| `app/dashboard/incomes/page.tsx`                              | Invalidar queries                           |
| `app/dashboard/transfers/page.tsx`                            | Invalidar queries                           |
| `app/dashboard/budgets/page.tsx`                              | Invalidar queries                           |
| `app/dashboard/exchange-rates/page.tsx`                       | Botones sync, columna fuente                |
| `app/dashboard/_components/exchange-rate-widget.tsx`          | Fix invalidacion                            |
| `app/dashboard/_components/recent-transactions.tsx`           | Icono alcancia, tipos nuevos                |
| `contexts/user-config-context.tsx`                            | Tema, deteccion sistema                     |
| `components/layout/header.tsx`                                | Sincronizar tema con BD                     |
| `app/layout.tsx`                                              | Script inicializacion tema                  |
| `app/dashboard/accounts/page.tsx`                             | Cambiar a tabla                             |
| `app/dashboard/categories/page.tsx`                           | Tabla expandible                            |
| `app/dashboard/jobs/_components/job-form.tsx`                 | InlineAccountModal, fix defaults            |
| `app/dashboard/budgets/_components/budget-form.tsx`           | InlineAccountModal, fix defaults            |
| `app/dashboard/inventory/_components/inventory-item-form.tsx` | Categoria opcional                          |
| `app/dashboard/inventory/page.tsx`                            | Mostrar "Sin categoria"                     |
| `app/dashboard/inventory/shopping-list/page.tsx`              | Selector moneda, conversiones               |
| `prisma/schema.prisma`                                        | Cooldowns separados, categoryId opcional    |

---

## Migracion

Despues de actualizar el codigo:

```bash
# Regenerar cliente Prisma
yarn db:generate

# Aplicar cambios de schema
yarn db:push
```

---

_WalletWise v1.2.0 - Correcciones y Mejoras (Completado)_
