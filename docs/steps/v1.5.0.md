# v1.5.0 - Calculadora de Conversion de Monedas

## Resumen

Nueva pagina con calculadora funcional que permite realizar operaciones matematicas y ver el resultado convertido a multiples monedas simultaneamente.

---

## Funcionalidad Principal

### Calculadora con Conversion Multi-Moneda

**Descripcion**: El usuario ingresa una expresion matematica en una moneda base y ve instantaneamente el resultado convertido a todas las monedas seleccionadas.

**Ejemplo de uso**:

```
Moneda origen: USD
Expresion: (100 + 50) * 2
Resultado: 300 USD

Conversiones seleccionadas:
- VES: 11,400.00 Bs. (tasa: 38.00)
- COP: 1,245,000.00 COP$ (tasa: 4,150.00)
- EUR: 276.00 EUR (tasa: 0.92)
```

---

## Especificaciones Tecnicas

### 1. Calculadora

**Operaciones soportadas**:
| Operador | Descripcion | Ejemplo |
|----------|-------------|---------|
| `+` | Suma | `100 + 50` = 150 |
| `-` | Resta | `100 - 30` = 70 |
| `*` | Multiplicacion | `100 * 2` = 200 |
| `/` | Division | `100 / 4` = 25 |
| `()` | Parentesis | `(100 + 50) * 2` = 300 |
| `.` | Decimales | `100.50 + 0.25` = 100.75 |

**Validaciones**:

- Division por cero: Mostrar error
- Expresion invalida: Mostrar error de sintaxis
- Parentesis desbalanceados: Mostrar error
- Resultado negativo: Permitido (mostrar en rojo)

**Implementacion**:

- Usar evaluacion segura (NO `eval()`)
- Implementar parser de expresiones matematicas
- Opcion: Usar libreria como `mathjs` o `expr-eval`

### 2. Selector de Monedas

**Moneda origen**:

- Select con todas las monedas disponibles
- Default: Moneda base del usuario (de UserConfig)

**Monedas destino**:

- Multi-select con checkboxes
- Permitir seleccionar/deseleccionar multiples
- Recordar seleccion en localStorage
- Opcion "Seleccionar todas"

### 3. Tasas de Cambio

**Fuente de tasas**:

- Usar `getLatestRate()` de `lib/currency-utils.ts`
- Soporta rutas intermedias (USD, USDT)
- Mostrar indicador de tipo de tasa:
  - Directa
  - Inversa
  - Via intermedia (USD/USDT)

**Actualizacion**:

- Boton para refrescar tasas
- Mostrar fecha/hora de ultima actualizacion
- Indicador visual si la tasa es antigua (>24h)

---

## Diseno de UI

### Layout Desktop

```
+----------------------------------------------------------+
|                    Calculadora                            |
+----------------------------------------------------------+
|                                                          |
|  Moneda: [USD v]                    [Refrescar Tasas]    |
|                                                          |
|  +----------------------------------------------------+  |
|  |                                                    |  |
|  |                              300.00                |  |  <- Display
|  |  (100 + 50) * 2 =                                  |  |
|  +----------------------------------------------------+  |
|                                                          |
|  +----+  +----+  +----+  +----+  +----+               |
|  | C  |  | () |  |  / |  |  * |  | <- |               |
|  +----+  +----+  +----+  +----+  +----+               |
|  +----+  +----+  +----+  +----+  +----+               |
|  | 7  |  | 8  |  | 9  |  |  - |  |    |               |
|  +----+  +----+  +----+  +----+  |    |               |
|  +----+  +----+  +----+  +----+  | =  |               |
|  | 4  |  | 5  |  | 6  |  |  + |  |    |               |
|  +----+  +----+  +----+  +----+  |    |               |
|  +----+  +----+  +----+  +----+  +----+               |
|  | 1  |  | 2  |  | 3  |  |  . |  |    |               |
|  +----+  +----+  +----+  +----+  |    |               |
|  +-----------+  +----+  +----+  |    |               |
|  |     0     |  | 00 |  |    |  |    |               |
|  +-----------+  +----+  +----+  +----+               |
|                                                          |
+----------------------------------------------------------+
|                                                          |
|  Conversiones                              [Editar]      |
|                                                          |
|  +----------------------------------------------------+  |
|  | [x] VES   Bs. 11,400.00          Tasa: 38.00      |  |
|  +----------------------------------------------------+  |
|  | [x] COP   COP$ 1,245,000.00      Tasa: 4,150.00   |  |
|  +----------------------------------------------------+  |
|  | [x] EUR   EUR 276.00             Tasa: 0.92       |  |
|  +----------------------------------------------------+  |
|  | [ ] USDT  (click para agregar)                     |  |
|  +----------------------------------------------------+  |
|                                                          |
+----------------------------------------------------------+
```

### Layout Mobile

```
+-------------------------+
|     Calculadora         |
+-------------------------+
| Moneda: [USD v]         |
+-------------------------+
|                         |
|              300.00     |
| (100 + 50) * 2 =        |
+-------------------------+
| C  | () |  / |  * | <- |
+----+----+----+----+----+
| 7  | 8  | 9  |  - |    |
+----+----+----+----+    |
| 4  | 5  | 6  |  + | =  |
+----+----+----+----+    |
| 1  | 2  | 3  |  . |    |
+----+----+----+----+----+
|    0    | 00 |         |
+---------+----+---------+
|                         |
| Conversiones    [+]     |
+-------------------------+
| VES  Bs. 11,400.00      |
| COP  COP$ 1,245,000     |
| EUR  EUR 276.00         |
+-------------------------+
```

---

## Estructura de Archivos

```
app/dashboard/calculator/
  page.tsx                    # Pagina principal
  _components/
    calculator-display.tsx    # Display de expresion y resultado
    calculator-keypad.tsx     # Teclado numerico
    currency-selector.tsx     # Selector de moneda origen
    conversion-list.tsx       # Lista de conversiones
    conversion-item.tsx       # Item individual de conversion
    currency-picker-modal.tsx # Modal para seleccionar monedas destino

lib/
  calculator.ts               # Parser y evaluador de expresiones
```

---

## Implementacion del Parser

### Opcion A: Libreria externa (Recomendado)

```bash
npm install expr-eval
# o
npm install mathjs
```

```typescript
// lib/calculator.ts
import { Parser } from "expr-eval";

const parser = new Parser();

export function evaluate(expression: string): number | null {
  try {
    const result = parser.evaluate(expression);
    if (!isFinite(result)) return null;
    return result;
  } catch {
    return null;
  }
}

export function isValidExpression(expression: string): boolean {
  try {
    parser.parse(expression);
    return true;
  } catch {
    return false;
  }
}
```

### Opcion B: Implementacion propia

```typescript
// lib/calculator.ts

// Tokenizer
type Token =
  | { type: "number"; value: number }
  | { type: "operator"; value: "+" | "-" | "*" | "/" }
  | { type: "paren"; value: "(" | ")" };

function tokenize(expr: string): Token[] {
  // ... implementar tokenizador
}

// Parser (Shunting Yard algorithm)
function toPostfix(tokens: Token[]): Token[] {
  // ... implementar algoritmo
}

// Evaluator
function evaluatePostfix(postfix: Token[]): number {
  // ... implementar evaluador
}

export function evaluate(expression: string): number | null {
  try {
    const tokens = tokenize(expression);
    const postfix = toPostfix(tokens);
    return evaluatePostfix(postfix);
  } catch {
    return null;
  }
}
```

---

## API de Conversiones

Usar funciones existentes de `lib/currency-utils.ts`:

```typescript
import { getLatestRate, getLatestRateByCode } from "@/lib/currency-utils";

// Obtener tasa entre dos monedas
const rate = await getLatestRateByCode("USD", "VES");
// { rate: 38.0, source: 'binance', isInverse: false, intermediateRoute?: {...} }

// Convertir monto
const converted = amount * rate.rate;
```

---

## Estado del Componente

```typescript
interface CalculatorState {
  // Expresion actual
  expression: string;
  // Resultado calculado
  result: number | null;
  // Error de calculo
  error: string | null;
  // Moneda origen
  sourceCurrency: string;
  // Monedas destino seleccionadas
  targetCurrencies: string[];
  // Tasas cargadas
  rates: Map<string, RateResult>;
  // Estado de carga
  isLoadingRates: boolean;
}
```

---

## Interacciones

### Teclado fisico

- Numeros (0-9): Agregar digito
- Operadores (+, -, \*, /): Agregar operador
- Parentesis: Agregar parentesis
- Enter: Calcular
- Backspace: Borrar ultimo caracter
- Escape: Limpiar todo

### Botones

- `C`: Limpiar todo
- `<-`: Borrar ultimo caracter
- `=`: Calcular resultado
- `()`: Agregar parentesis (inteligente)
- Numeros y operadores: Agregar a expresion

---

## Consideraciones UX

1. **Feedback inmediato**: Calcular mientras se escribe (debounced)
2. **Historial**: Opcional - guardar ultimas 10 operaciones
3. **Copiar resultado**: Click en cualquier conversion para copiar
4. **Persistencia**: Guardar monedas seleccionadas en localStorage
5. **Accesibilidad**: Soporte completo de teclado

---

## Sidebar

Agregar entrada en el sidebar:

```typescript
// En SIDEBAR_ITEMS
{
  id: "tools",
  type: "group",
  title: "Herramientas",
  icon: Wrench, // o Calculator
  defaultOpen: false,
  items: [
    { title: "Calculadora", href: "/dashboard/calculator", icon: Calculator },
  ],
}
```

O como item standalone:

```typescript
{
  id: "calculator",
  type: "item",
  title: "Calculadora",
  href: "/dashboard/calculator",
  icon: Calculator,
}
```

---

## Orden de Implementacion

1. **Fase 1**: Crear estructura de pagina y componentes basicos
2. **Fase 2**: Implementar calculadora (parser + UI)
3. **Fase 3**: Agregar selector de moneda origen
4. **Fase 4**: Implementar lista de conversiones
5. **Fase 5**: Agregar modal de seleccion de monedas
6. **Fase 6**: Integrar con tasas de cambio reales
7. **Fase 7**: Agregar al sidebar
8. **Fase 8**: Pulir responsive y UX

---

## Dependencias

```bash
# Opcion recomendada para parser
npm install expr-eval
```

No se requieren otras dependencias nuevas.

---

## Tests Manuales

1. [ ] Expresion simple: `100 + 50` = 150
2. [ ] Expresion con parentesis: `(100 + 50) * 2` = 300
3. [ ] Division por cero: Error mostrado
4. [ ] Decimales: `100.50 + 0.25` = 100.75
5. [ ] Operaciones encadenadas: `10 + 20 - 5 * 2` = 20
6. [ ] Cambiar moneda origen: Conversiones se actualizan
7. [ ] Agregar/quitar moneda destino: Lista se actualiza
8. [ ] Teclado fisico: Todas las teclas funcionan
9. [ ] Mobile: Layout responsive correcto
10. [ ] Copiar conversion: Click copia al clipboard

---

_v1.5.0 - Calculadora de Conversion de Monedas_
