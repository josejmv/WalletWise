# Modulo Incomes

Registro y gestion de ingresos asociados a trabajos.

---

## Descripcion

Permite registrar ingresos provenientes de trabajos fijos o freelance, con soporte multi-moneda y conversion automatica.

---

## Modelo de Datos

| Campo           | Tipo     | Descripcion                     |
| --------------- | -------- | ------------------------------- |
| id              | UUID     | Identificador unico             |
| job             | Job      | Trabajo origen del ingreso      |
| account         | Account  | Cuenta donde se deposita        |
| amount          | Decimal  | Monto del ingreso               |
| currency        | Currency | Moneda del ingreso              |
| exchangeRate    | Decimal? | Tasa de cambio al momento       |
| amountInBase    | Decimal  | Monto convertido a USD          |
| date            | DateTime | Fecha del ingreso               |
| description     | string?  | Descripcion opcional            |
| isAutoGenerated | boolean  | Si fue generado automaticamente |
| createdAt       | DateTime | Fecha de registro               |

---

## API Endpoints

### GET /api/incomes

Lista todos los ingresos.

**Query params:**

- `jobId`: Filtrar por trabajo
- `accountId`: Filtrar por cuenta
- `startDate`: Fecha inicio
- `endDate`: Fecha fin
- `page`: Numero de pagina
- `limit`: Resultados por pagina

**Response:**

```json
{
  "data": [
    {
      "id": "uuid",
      "job": { "id": "uuid", "name": "Empresa ABC", "type": "fixed" },
      "account": { "id": "uuid", "name": "Banco Principal" },
      "amount": 2500.0,
      "currency": { "code": "USD", "symbol": "$" },
      "amountInBase": 2500.0,
      "date": "2024-01-30",
      "isAutoGenerated": true
    }
  ],
  "pagination": {
    "total": 24,
    "page": 1,
    "limit": 10
  }
}
```

### POST /api/incomes

Crea un nuevo ingreso manual.

**Body:**

```json
{
  "jobId": "uuid",
  "accountId": "uuid",
  "amount": 1500.0,
  "currencyId": "uuid",
  "date": "2024-01-15",
  "description": "Pago proyecto web"
}
```

### GET /api/incomes/:id

Obtiene detalle de un ingreso.

### PUT /api/incomes/:id

Actualiza un ingreso (solo manuales).

### DELETE /api/incomes/:id

Elimina un ingreso (solo manuales).

---

## Estructura de Archivos

```
app/
├── (dashboard)/
│   └── incomes/
│       ├── page.tsx              # Lista de ingresos
│       ├── new/
│       │   └── page.tsx          # Crear ingreso manual
│       ├── [id]/
│       │   └── page.tsx          # Detalle/editar
│       └── _components/
│           ├── income-list.tsx
│           ├── income-card.tsx
│           └── income-form.tsx
│
└── api/
    └── incomes/
        ├── route.ts
        ├── [id]/
        │   └── route.ts
        ├── service.ts
        ├── repository.ts
        ├── schema.ts
        └── types.ts
```

---

## Flujos de Negocio

### Generacion Automatica desde Trabajo Fijo

```
Trabajo fijo activo con periodicidad mensual, payDay = 30

Cada dia a las 00:00:
  Si hoy.dia === trabajo.payDay:
    Crear Income:
      - jobId: trabajo.id
      - accountId: trabajo.accountId
      - amount: trabajo.salary
      - currencyId: trabajo.currencyId
      - date: hoy
      - isAutoGenerated: true

    Actualizar cuenta:
      - account.balance += amount (convertido si es necesario)
```

### Conversion de Moneda

Cuando el ingreso es en moneda diferente a la cuenta:

```typescript
const exchangeRate = await getExchangeRate(income.currency, account.currency);
const convertedAmount = income.amount * exchangeRate;

// Guardar tasa usada para referencia
income.exchangeRate = exchangeRate;
income.amountInBase = income.amount * getExchangeRate(income.currency, "USD");
```

---

## Validaciones

| Campo     | Regla                                        |
| --------- | -------------------------------------------- |
| jobId     | Opcional desde v1.4.0 (Ingreso Extra si null)|
| accountId | Requerido, debe existir y activa             |
| amount    | Requerido, > 0                               |
| date      | Requerida, no futura                         |

---

## Sistema de Vueltos (v1.6.0)

Permite registrar vueltos dados al recibir un ingreso, con soporte para vueltos en diferente moneda y/o cuenta.

### Campos Adicionales

| Campo            | Tipo      | Descripcion                              |
| ---------------- | --------- | ---------------------------------------- |
| hasChange        | boolean   | Si el ingreso tiene vuelto asociado      |
| changeAmount     | Decimal?  | Monto del vuelto dado                    |
| changeAccountId  | string?   | Cuenta de donde sale el vuelto           |
| changeCurrencyId | string?   | Moneda del vuelto                        |
| changeTransferId | string?   | ID de transferencia asociada (si aplica) |

### Logica de Calculo

```
Ejemplo: Ingreso de 10 USD, vuelto dado de 3671.77 COP
Tasa: 1 USD = 3671.77 COP

Calculo:
- Vuelto en USD = 3671.77 / 3671.77 = 1 USD
- Credito neto = 10 - 1 = 9 USD

Resultado:
- Cuenta USD: +9 USD
- Cuenta COP (si diferente): -3671.77 COP
```

### Casos de Uso

1. **Misma cuenta y moneda**: Credito neto = monto - vuelto
2. **Diferente cuenta, misma moneda**: Credito completo + transferencia de vuelto
3. **Diferente moneda**: Conversion automatica usando tasa del sistema

---

## Ver tambien

- [Jobs](../jobs/README.md) - Fuentes de ingresos
- [Accounts](../accounts/README.md) - Cuentas destino
- [Dashboard](../dashboard/README.md) - Resumen de ingresos
