# Modulo Expenses

Gestion de gastos unicos y recurrentes con soporte multi-moneda.

---

## Descripcion

Permite registrar gastos, clasificarlos por categoria, y gestionar gastos recurrentes como suscripciones y servicios.

---

## Tipos de Gasto

### Gasto Unico

Registro manual cuando ocurre el gasto.

### Gasto Recurrente

Configurado con periodicidad para generacion automatica.

| Periodicidad | Codigo     | Descripcion        |
| ------------ | ---------- | ------------------ |
| Semanal      | `weekly`   | Cada 7 dias        |
| Quincenal    | `biweekly` | Cada 15 dias       |
| Mensual      | `monthly`  | Mismo dia cada mes |
| Anual        | `yearly`   | Mismo dia cada año |

---

## Modelo de Datos

| Campo           | Tipo      | Descripcion                     |
| --------------- | --------- | ------------------------------- |
| id              | UUID      | Identificador unico             |
| category        | Category  | Categoria del gasto             |
| account         | Account   | Cuenta de origen                |
| amount          | Decimal   | Monto del gasto                 |
| currency        | Currency  | Moneda del gasto                |
| exchangeRate    | Decimal?  | Tasa oficial al momento         |
| auxiliaryRate   | Decimal?  | Tasa del comercio (opcional)    |
| amountInBase    | Decimal   | Monto convertido a USD          |
| rateDifference  | Decimal?  | Diferencia entre tasas          |
| date            | DateTime  | Fecha del gasto                 |
| description     | string?   | Descripcion opcional            |
| isRecurring     | boolean   | Si es gasto recurrente          |
| periodicity     | enum?     | Periodicidad si es recurrente   |
| nextDueDate     | DateTime? | Proxima fecha de pago           |
| isAutoGenerated | boolean   | Si fue generado automaticamente |
| createdAt       | DateTime  | Fecha de registro               |

---

## API Endpoints

### GET /api/expenses

Lista todos los gastos.

**Query params:**

- `categoryId`: Filtrar por categoria
- `accountId`: Filtrar por cuenta
- `isRecurring`: `true` | `false`
- `startDate`: Fecha inicio
- `endDate`: Fecha fin
- `page`: Numero de pagina
- `limit`: Resultados por pagina

**Response:**

```json
{
  "data": [
    {
      "id": "uuid",
      "category": {
        "id": "uuid",
        "name": "Streaming",
        "parent": { "name": "Entretenimiento" }
      },
      "account": { "id": "uuid", "name": "Tarjeta Credito" },
      "amount": 15.99,
      "currency": { "code": "USD" },
      "amountInBase": 15.99,
      "date": "2024-01-15",
      "description": "Netflix mensual",
      "isRecurring": true,
      "periodicity": "monthly",
      "nextDueDate": "2024-02-15"
    }
  ],
  "pagination": { "total": 156, "page": 1, "limit": 10 }
}
```

### POST /api/expenses

Crea un nuevo gasto.

**Body (gasto unico):**

```json
{
  "categoryId": "uuid",
  "accountId": "uuid",
  "amount": 45.5,
  "currencyId": "uuid",
  "date": "2024-01-15",
  "description": "Almuerzo restaurante",
  "auxiliaryRate": 4100.0
}
```

**Body (gasto recurrente):**

```json
{
  "categoryId": "uuid",
  "accountId": "uuid",
  "amount": 15.99,
  "currencyId": "uuid",
  "date": "2024-01-15",
  "description": "Netflix",
  "isRecurring": true,
  "periodicity": "monthly"
}
```

### GET /api/expenses/:id

Obtiene detalle de un gasto.

### PUT /api/expenses/:id

Actualiza un gasto.

### DELETE /api/expenses/:id

Elimina un gasto.

### GET /api/expenses/recurring

Lista solo gastos recurrentes activos.

### POST /api/expenses/:id/skip

Salta la proxima ocurrencia de un gasto recurrente.

---

## Estructura de Archivos

```
app/
├── (dashboard)/
│   └── expenses/
│       ├── page.tsx              # Lista de gastos
│       ├── new/
│       │   └── page.tsx          # Crear gasto
│       ├── recurring/
│       │   └── page.tsx          # Gastos recurrentes
│       ├── [id]/
│       │   └── page.tsx          # Detalle/editar
│       └── _components/
│           ├── expense-list.tsx
│           ├── expense-card.tsx
│           ├── expense-form.tsx
│           └── recurring-list.tsx
│
└── api/
    └── expenses/
        ├── route.ts
        ├── [id]/
        │   └── route.ts
        ├── recurring/
        │   └── route.ts
        ├── service.ts
        ├── repository.ts
        ├── schema.ts
        └── types.ts
```

---

## Flujos de Negocio

### Calculo de Tasa Auxiliar

Cuando se registra un gasto con tasa del comercio diferente a la oficial:

```
tasaOficial = 4155.00 (de la API)
tasaComercio = 4100.00 (ingresada por usuario)

monto = 100 USD

// Valor si usara tasa oficial
valorOficial = 100 * 4155 = 415,500 COP

// Valor pagado en comercio
valorComercio = 100 * 4100 = 410,000 COP

// Diferencia (positivo = ahorro)
diferencia = valorOficial - valorComercio = 5,500 COP
```

### Generacion de Gastos Recurrentes

```
Cada dia a las 00:00:
  Para cada gasto recurrente donde nextDueDate === hoy:
    Crear nuevo Expense:
      - Copiar datos del gasto recurrente
      - date: hoy
      - isAutoGenerated: true

    Actualizar gasto recurrente:
      - nextDueDate = calcularProximaFecha(periodicity)

    Actualizar cuenta:
      - account.balance -= amount
```

### Calcular Proxima Fecha

```typescript
function calcularProximaFecha(fecha: Date, periodicidad: string): Date {
  switch (periodicidad) {
    case "weekly":
      return addDays(fecha, 7);
    case "biweekly":
      return addDays(fecha, 15);
    case "monthly":
      return addMonths(fecha, 1);
    case "yearly":
      return addYears(fecha, 1);
  }
}
```

---

## Validaciones

| Campo       | Regla                            |
| ----------- | -------------------------------- |
| categoryId  | Requerido, debe existir          |
| accountId   | Requerido, debe existir y activa |
| amount      | Requerido, > 0                   |
| date        | Requerida                        |
| periodicity | Requerido si isRecurring = true  |

---

## Sistema de Vueltos (v1.6.0)

Permite registrar vueltos recibidos al realizar un gasto, con soporte para vueltos en diferente moneda y/o cuenta.

### Campos Adicionales

| Campo            | Tipo      | Descripcion                              |
| ---------------- | --------- | ---------------------------------------- |
| hasChange        | boolean   | Si el gasto tiene vuelto asociado        |
| changeAmount     | Decimal?  | Monto del vuelto recibido                |
| changeAccountId  | string?   | Cuenta donde se deposita el vuelto       |
| changeCurrencyId | string?   | Moneda del vuelto (= moneda de cuenta)   |
| changeTransferId | string?   | ID de transferencia asociada (si aplica) |

### Reglas

- **Moneda del vuelto**: Siempre es la moneda de la cuenta de vuelto (no seleccionable)
- **Monto guardado**: Es el monto NETO (original - equivalente del vuelto)
- **Descripcion**: Incluye automaticamente info del vuelto (ej: "Vuelto: COP$12000.00 a efectivo")

### Logica de Calculo

```
Ejemplo: Gasto de 10 USD, vuelto de 12000 COP a cuenta COP
Tasa: 1 USD = 3671.77 COP

Calculo:
1. Equivalente del vuelto = 12000 / 3671.77 = 3.27 USD
2. Gasto neto = 10 - 3.27 = 6.73 USD
3. Transferencia = 3.27 USD -> 12000 COP

Resultado en balances:
- Cuenta USD: -6.73 (gasto) -3.27 (transferencia) = -10 USD
- Cuenta COP: +12000 COP

Resultado en historial:
- Gasto: 6.73 USD (con descripcion del vuelto)
- Transferencia: 3.27 USD -> 12000 COP
```

### Casos de Uso

1. **Misma cuenta**: Debito neto = monto - vuelto (sin transferencia)
2. **Diferente cuenta**: Debito neto + transferencia del equivalente

---

## Seleccion Jerarquica de Categorias (v1.6.0)

El formulario de gastos usa dos selectores para categorias:

1. **Categoria padre** (requerido): Selecciona la categoria principal
2. **Subcategoria** (opcional): Selecciona una subcategoria del padre

Si no se selecciona subcategoria, el gasto se registra con la categoria padre.

---

## Ver tambien

- [Categories](../categories/README.md) - Clasificacion de gastos
- [Accounts](../accounts/README.md) - Cuentas de origen
- [Exchange Rates](../exchange-rates/README.md) - Tasas de cambio
- [Budgets](../budgets/README.md) - Control de presupuesto
