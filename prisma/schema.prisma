generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum JobType {
  fixed
  freelance
}

enum JobPeriodicity {
  biweekly
  monthly
  one_time
}

enum JobStatus {
  active
  archived
  pending
}

enum ExpensePeriodicity {
  weekly
  monthly
  yearly
}

enum BudgetType {
  goal
  envelope
}

enum BudgetStatus {
  active
  completed
  cancelled
}

enum AccountTypeEnum {
  bank
  cash
  digital_wallet
  credit_card
}

enum InventoryUnit {
  unidades
  kg
  g
  L
  mL
  paquetes
}

enum ExchangeRateSource {
  official
  binance
  manual
}

enum TransferType {
  account_to_account
  account_to_budget
  budget_to_account
}

// ============================================
// MODELS
// ============================================

model Currency {
  id     String  @id @default(uuid())
  code   String  @unique // USD, COP, VES
  name   String // Dólar estadounidense, Peso colombiano, etc.
  symbol String // $, COP$, Bs.
  isBase Boolean @default(false)

  // Relations
  accounts              Account[]
  jobs                  Job[]
  incomes               Income[]
  expenses              Expense[]
  transfers             Transfer[]
  budgets               Budget[]
  exchangeRatesFrom     ExchangeRate[] @relation("FromCurrency")
  exchangeRatesTo       ExchangeRate[] @relation("ToCurrency")
  inventoryItems        InventoryItem[]
  inventoryPriceHistory InventoryPriceHistory[]
  userConfigs           UserConfig[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("currencies")
}

model ExchangeRate {
  id             String             @id @default(uuid())
  fromCurrencyId String
  toCurrencyId   String
  rate           Decimal            @db.Decimal(18, 8)
  source         ExchangeRateSource @default(official)
  fetchedAt      DateTime           @default(now())

  // Relations
  fromCurrency Currency @relation("FromCurrency", fields: [fromCurrencyId], references: [id])
  toCurrency   Currency @relation("ToCurrency", fields: [toCurrencyId], references: [id])

  createdAt DateTime @default(now())

  @@index([fromCurrencyId, toCurrencyId])
  @@index([fetchedAt])
  @@index([source])
  @@map("exchange_rates")
}

model ExchangeRateSyncLog {
  id         String             @id @default(uuid())
  source     ExchangeRateSource
  status     String // success, error
  message    String?
  ratesCount Int                @default(0)
  syncedAt   DateTime           @default(now())

  @@index([source])
  @@index([syncedAt])
  @@map("exchange_rate_sync_logs")
}

model AccountType {
  id          String          @id @default(uuid())
  name        String          @unique
  type        AccountTypeEnum @unique
  description String?
  // v1.3.0: Active status with default true
  isActive    Boolean         @default(true)

  // Relations
  accounts Account[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("account_types")
}

model Account {
  id            String  @id @default(uuid())
  name          String
  accountTypeId String
  currencyId    String
  balance       Decimal @default(0) @db.Decimal(18, 2)
  isActive      Boolean @default(true)

  // Relations
  accountType         AccountType          @relation(fields: [accountTypeId], references: [id])
  currency            Currency             @relation(fields: [currencyId], references: [id])
  jobs                Job[]
  incomes             Income[]
  expenses            Expense[]
  transfersFrom       Transfer[]           @relation("FromAccount")
  transfersTo         Transfer[]           @relation("ToAccount")
  budgets             Budget[]
  contributionsFrom   BudgetContribution[] @relation("ContributionFrom")
  contributionsTo     BudgetContribution[] @relation("ContributionTo")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([accountTypeId])
  @@index([currencyId])
  @@map("accounts")
}

model Job {
  id          String          @id @default(uuid())
  name        String
  type        JobType
  salary      Decimal         @db.Decimal(18, 2)
  currencyId  String
  accountId   String
  periodicity JobPeriodicity
  payDay      Int?            // Día del mes (1-31), null para one_time
  status      JobStatus       @default(active)
  startDate   DateTime        @default(now())
  endDate     DateTime?

  // Relations
  currency Currency @relation(fields: [currencyId], references: [id])
  account  Account  @relation(fields: [accountId], references: [id])
  incomes  Income[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([currencyId])
  @@index([accountId])
  @@index([status])
  @@map("jobs")
}

model Category {
  id       String  @id @default(uuid())
  name     String
  parentId String?
  color    String? // Hex color for UI
  icon     String? // Icon identifier

  // Relations
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  expenses    Expense[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([parentId])
  @@map("categories")
}

model Income {
  id           String   @id @default(uuid())
  jobId        String?  // v1.4.0: Optional - null means "Ingreso Extra"
  accountId    String
  amount       Decimal  @db.Decimal(18, 2)
  currencyId   String
  officialRate Decimal? @db.Decimal(18, 8) // Tasa oficial de la API
  customRate   Decimal? @db.Decimal(18, 8) // Tasa auxiliar del comercio
  date         DateTime @default(now())
  description  String?

  // Relations
  job      Job?     @relation(fields: [jobId], references: [id]) // v1.4.0: Optional
  account  Account  @relation(fields: [accountId], references: [id])
  currency Currency @relation(fields: [currencyId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([jobId])
  @@index([accountId])
  @@index([currencyId])
  @@index([date])
  @@map("incomes")
}

model Expense {
  id           String              @id @default(uuid())
  categoryId   String
  accountId    String
  amount       Decimal             @db.Decimal(18, 2)
  currencyId   String
  officialRate Decimal?            @db.Decimal(18, 8) // Tasa oficial de la API
  customRate   Decimal?            @db.Decimal(18, 8) // Tasa auxiliar del comercio
  isRecurring  Boolean             @default(false)
  periodicity  ExpensePeriodicity?
  nextDueDate  DateTime?           // Próxima fecha para gastos recurrentes
  date         DateTime            @default(now())
  description  String?

  // Relations
  category Category @relation(fields: [categoryId], references: [id])
  account  Account  @relation(fields: [accountId], references: [id])
  currency Currency @relation(fields: [currencyId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryId])
  @@index([accountId])
  @@index([currencyId])
  @@index([date])
  @@index([isRecurring])
  @@map("expenses")
}

model Transfer {
  id            String       @id @default(uuid())
  type          TransferType @default(account_to_account)
  fromAccountId String? // null si es budget_to_account
  toAccountId   String? // null si es account_to_budget
  fromBudgetId  String? // para budget_to_account
  toBudgetId    String? // para account_to_budget
  amount        Decimal      @db.Decimal(18, 2)
  currencyId    String
  exchangeRate  Decimal?     @db.Decimal(18, 8) // Si las cuentas tienen diferente moneda
  officialRate  Decimal?     @db.Decimal(18, 8) // Tasa oficial de la API
  customRate    Decimal?     @db.Decimal(18, 8) // Tasa auxiliar del comercio
  date          DateTime     @default(now())
  description   String?

  // Relations
  fromAccount Account?  @relation("FromAccount", fields: [fromAccountId], references: [id])
  toAccount   Account?  @relation("ToAccount", fields: [toAccountId], references: [id])
  fromBudget  Budget?   @relation("FromBudget", fields: [fromBudgetId], references: [id])
  toBudget    Budget?   @relation("ToBudget", fields: [toBudgetId], references: [id])
  currency    Currency  @relation(fields: [currencyId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([fromAccountId])
  @@index([toAccountId])
  @@index([fromBudgetId])
  @@index([toBudgetId])
  @@index([date])
  @@index([type])
  @@map("transfers")
}

model Budget {
  id            String       @id @default(uuid())
  name          String
  type          BudgetType
  // v1.3.0: targetAmount is optional (budgets without goal)
  targetAmount  Decimal?     @db.Decimal(18, 2)
  currentAmount Decimal      @default(0) @db.Decimal(18, 2)
  currencyId    String
  accountId     String // Requerido para ambos tipos (bloquea saldo)
  deadline      DateTime?
  status        BudgetStatus @default(active)

  // Relations
  currency      Currency             @relation(fields: [currencyId], references: [id])
  account       Account              @relation(fields: [accountId], references: [id])
  contributions BudgetContribution[]
  transfersFrom Transfer[]           @relation("FromBudget")
  transfersTo   Transfer[]           @relation("ToBudget")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([currencyId])
  @@index([accountId])
  @@index([status])
  @@map("budgets")
}

model BudgetContribution {
  id              String   @id @default(uuid())
  budgetId        String
  fromAccountId   String? // Cuenta de donde vino la contribucion (null para retiros)
  toAccountId     String? // Cuenta a donde fue el retiro (null para contribuciones)
  amount          Decimal  @db.Decimal(18, 2) // Positivo = contribucion, Negativo = retiro
  date            DateTime @default(now())
  description     String?

  // Relations
  budget      Budget   @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  fromAccount Account? @relation("ContributionFrom", fields: [fromAccountId], references: [id])
  toAccount   Account? @relation("ContributionTo", fields: [toAccountId], references: [id])

  createdAt DateTime @default(now())

  @@index([budgetId])
  @@index([fromAccountId])
  @@index([toAccountId])
  @@index([date])
  @@map("budget_contributions")
}

// ============================================
// USER CONFIG
// ============================================

model UserConfig {
  id                 String    @id @default(uuid())
  baseCurrencyId     String
  dateFormat         String    @default("DD/MM/YYYY") // DD/MM/YYYY, MM/DD/YYYY, YYYY-MM-DD
  numberFormat       String    @default("es-CO") // es-CO, en-US
  theme              String    @default("system") // system, light, dark
  sidebarConfig      Json      @default("[]")
  lastRateSyncAt     DateTime? // Legacy - for backwards compatibility
  lastOfficialSyncAt DateTime? // Cooldown for official API sync
  lastBinanceSyncAt  DateTime? // Cooldown for Binance P2P sync

  // Relations
  baseCurrency Currency @relation(fields: [baseCurrencyId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_config")
}

// ============================================
// INVENTORY MODELS
// ============================================

model InventoryCategory {
  id          String  @id @default(uuid())
  name        String  @unique
  icon        String?
  color       String?
  description String?

  // Relations
  items InventoryItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("inventory_categories")
}

model InventoryItem {
  id              String        @id @default(uuid())
  name            String
  categoryId      String?
  currentQuantity Decimal       @default(0) @db.Decimal(10, 2)
  maxQuantity     Decimal       @db.Decimal(10, 2)
  minQuantity     Decimal       @default(0) @db.Decimal(10, 2)
  unit            InventoryUnit @default(unidades)
  estimatedPrice  Decimal       @db.Decimal(18, 2)
  currencyId      String
  isActive        Boolean       @default(true)
  notes           String?

  // Relations
  category     InventoryCategory?      @relation(fields: [categoryId], references: [id])
  currency     Currency                @relation(fields: [currencyId], references: [id])
  priceHistory InventoryPriceHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryId])
  @@index([currencyId])
  @@index([isActive])
  @@map("inventory_items")
}

model InventoryPriceHistory {
  id         String   @id @default(uuid())
  itemId     String
  price      Decimal  @db.Decimal(18, 2)
  currencyId String
  date       DateTime @default(now())
  source     String?

  // Relations
  item     InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  currency Currency      @relation(fields: [currencyId], references: [id])

  createdAt DateTime @default(now())

  @@index([itemId])
  @@index([date])
  @@map("inventory_price_history")
}
